# Mac App for OFFED
# .github/workflows/macos-build.yml
name: macOS Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown
        
    - name: Setup Xcode (idempotent)
      run: |
        # Accept Xcode license and select developer directory
        sudo xcodebuild -license accept || true
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer || true
        
        # Verify installation
        xcode-select -p
        xcodebuild -version
    - name: Install Node.js and npm
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Create package.json (for npm cache)
      run: |
        mkdir -p .npm-cache
        echo '{}' > package.json
        
    - name: Install TailwindCSS CLI
      run: npm install -D tailwindcss @tailwindcss/cli
      
    - name: Install Trunk
      run: cargo install trunk
      
    - name: Download fontc sidecar (Apple Silicon)
      run: |
        mkdir -p crates/offed-tauri/binaries
        cd crates/offed-tauri/binaries
        curl -L -o fontc-aarch64-apple-darwin.tar.gz \
          https://github.com/googlefonts/fontc/releases/latest/download/fontc-aarch64-apple-darwin.tar.gz
        tar -xzf fontc-aarch64-apple-darwin.tar.gz
        mv fontc fontc-aarch64-apple-darwin
        chmod +x fontc-aarch64-apple-darwin
        rm fontc-aarch64-apple-darwin.tar.gz
        
    - name: Run tests
      run: make test
      
    - name: Check code quality
      run: make check
      
    - name: Format code
      run: make fmt
      
    - name: Build macOS app
      run: make build
      
    - name: Upload macOS app bundle
      uses: actions/upload-artifact@v4
      with:
        name: offed-macos-app
        path: |
          target/release/bundle/macos/
        retention-days: 30
        
