# .github/workflows/macos-build.yml
name: macOS Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout GitLab repository
      run: |
        git clone --depth=1 https://gitlab.com/mitradranirban/offed.git offed

    - name: Create Package Manifests
      working-directory: ./offed
      run: |
        cat > package.json <<'EOF'
        { 
          "name": "offed-mac", 
          "version": "0.0.0",
          "dependencies": {
            "tailwindcss": "^4.0.0",
            "@tailwindcss/cli": "^4.0.0"
          }
        }
        EOF
       
        touch package-lock.json

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Tailwind and Tauri CLI
      working-directory: ./offed
      run: |
        npm install
        npm install -g @tauri-apps/cli
        # LINKING: This is the fix for macOS OS Error 2
        # It puts the local tailwind binary into the system path
        sudo ln -s $(pwd)/node_modules/.bin/tailwindcss /usr/local/bin/tailwindcss
        
        # Verify it's globally accessible
        tailwindcss --version
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin

    - name: Install Trunk (Pre-compiled)
      working-directory: ./offed
      run: |
        curl -L -o trunk.tar.gz https://github.com/trunk-rs/trunk/releases/download/v0.21.14/trunk-aarch64-apple-darwin.tar.gz
        tar -xzf trunk.tar.gz
        sudo mv trunk /usr/local/bin/

    - name: Download fontc sidecar
      working-directory: ./offed
      run: |
        mkdir -p crates/offed-tauri/binaries
        curl -L -o fontc.tar.gz https://github.com/googlefonts/fontc/releases/latest/download/fontc-aarch64-apple-darwin.tar.gz
        tar -xzf fontc.tar.gz -C crates/offed-tauri/binaries
        mv crates/offed-tauri/binaries/fontc crates/offed-tauri/binaries/fontc-aarch64-apple-darwin
        chmod +x crates/offed-tauri/binaries/fontc-aarch64-apple-darwin

     
    - name: Build Frontend (Trunk)
      working-directory: ./offed/crates/offed-wasm
      run: |
        TRUNK_TOOLS_TAILWIND=$TAILWIND_BIN trunk build --release

    - name: Build Desktop App (Tauri)
      working-directory: ./offed/crates/offed-tauri
      run: tauri build

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: offed-macos-app
        path: ./offed/target/release/bundle/macos/*.app
