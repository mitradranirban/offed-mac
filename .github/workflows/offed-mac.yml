# .github/workflows/macos-build.yml
name: macOS Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout GitLab repository
      run: |
        git clone --depth=1 https://gitlab.com/mitradranirban/offed.git offed
        
    - name: Install Rust with WASM Target
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin, x86_64-apple-darwin, wasm32-unknown-unknown
   
    - name: Create Package Manifests
      working-directory: ./offed
      run: |
        cat > package.json <<'EOF'
        { 
          "name": "offed-mac", 
          "version": "0.2.0",
          "dependencies": {
            "tailwindcss": "^4.0.0",
            "@tailwindcss/cli": "^4.0.0"
          }
        }
        EOF
       
        touch package-lock.json

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Tailwind and Tauri CLI
      working-directory: ./offed
      run: |
        npm install
        npm install -g @tauri-apps/cli
        # LINKING: This is the fix for macOS OS Error 2
        # It puts the local tailwind binary into the system path
        sudo ln -s $(pwd)/node_modules/.bin/tailwindcss /usr/local/bin/tailwindcss
        
        # Verify it's globally accessible
        tailwindcss --version
 
 

    - name: Install Trunk (Pre-compiled)
      working-directory: ./offed
      run: |
        curl -L -o trunk.tar.gz https://github.com/trunk-rs/trunk/releases/download/v0.21.14/trunk-aarch64-apple-darwin.tar.gz
        tar -xzf trunk.tar.gz
        sudo mv trunk /usr/local/bin/

    - name: Download and Create Universal fontc sidecar
      working-directory: ./offed
      run: |
        mkdir -p crates/offed-tauri/binaries
        # 1. Download Silicon version
        curl -L -o fontc_arm.tar.gz https://github.com/googlefonts/fontc/releases/latest/download/fontc-aarch64-apple-darwin.tar.gz
        tar -xzf fontc_arm.tar.gz
        mv fontc fontc-aarch64
        
        # 2. Download Intel version
        curl -L -o fontc_intel.tar.gz https://github.com/googlefonts/fontc/releases/latest/download/fontc-x86_64-apple-darwin.tar.gz
        tar -xzf fontc_intel.tar.gz
        mv fontc fontc-x86_64
        
        # 3. MERGE into a Universal Binary
        # This creates the exact file Tauri is looking for
        lipo -create fontc-aarch64 fontc-x86_64 -output crates/offed-tauri/binaries/fontc-universal-apple-darwin
        
        # 4. Clean up and set permissions
        chmod +x crates/offed-tauri/binaries/fontc-universal-apple-darwin
        rm fontc-aarch64 fontc-x86_64 *.tar.gz
     
    - name: Build Frontend (Trunk)
      working-directory: ./offed/crates/offed-wasm
      run: |
        TRUNK_TOOLS_TAILWIND=$TAILWIND_BIN trunk build --release

    - name: Build Desktop App (Tauri)
      working-directory: ./offed/crates/offed-tauri
      run: tauri build --target universal-apple-darwin

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: offed-macos-app
        path: |
          ./offed/target/release/bundle/macos/*.app
          ./offed/target/release/bundle/dmg/*.dmg
