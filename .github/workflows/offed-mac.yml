# Mac App for OFFED
# .github/workflows/macos-build.yml
name: macOS Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-14
    
    steps:
    - name: Checkout GitLab repository
      run: | 
        git clone --depth=1 https://gitlab.com/mitradranirban/offed.git offed
        ls -la offed
      
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown
        
    - name: Setup Xcode (idempotent)
      run: |
        # Accept Xcode license and select developer directory
        sudo xcodebuild -license accept || true
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer || true
        
        # Verify installation
        xcode-select -p
        xcodebuild -version
    - name: Create package.json and package-lock.json (for npm cache)
      run: |
        # minimal package.json so npm has a project root
        cat > package.json <<'EOF'
        {
          "name": "offed-mac",
          "version": "0.0.0"
        }
        EOF

        # minimal package-lock.json (lockfileVersion 2 for npm@7+)
        cat > package-lock.json <<'EOF'
        {
          "name": "offed-mac",
          "version": "0.0.0",
          "lockfileVersion": 2,
          "requires": true,
          "packages": {
            "": {
              "name": "offed-mac",
              "version": "0.0.0"
            }
          },
          "dependencies": {}
        }
        EOF
        
      
    - name: Install Node.js and npm (no cache)
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install TailwindCSS CLI
      working-directory: offed
      run: npm install -D tailwindcss @tailwindcss/cli
      
    - name: Install Trunk
      run: cargo install trunk
      
    - name: Download fontc sidecar (Apple Silicon)
      working-directory: offed
      run: |
        mkdir -p crates/offed-tauri/binaries
        cd crates/offed-tauri/binaries
        curl -L -o fontc-aarch64-apple-darwin.tar.gz \
          https://github.com/googlefonts/fontc/releases/latest/download/fontc-aarch64-apple-darwin.tar.gz
        tar -xzf fontc-aarch64-apple-darwin.tar.gz
        mv fontc fontc-aarch64-apple-darwin
        chmod +x fontc-aarch64-apple-darwin
        rm fontc-aarch64-apple-darwin.tar.gz
      
    - name: Build macOS app
      working-directory: offed
      run: make build
      
    - name: Upload macOS app bundle
      uses: actions/upload-artifact@v4
      with:
        name: offed-macos-app
        path: |
          offed/target/release/bundle/macos/
        retention-days: 30
        
